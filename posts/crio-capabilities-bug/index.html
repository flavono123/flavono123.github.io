<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>컨테이너 런타임 CRI-O 사용 시 오류 해결: ping: permission denied (are you root?) | flavono123</title>
<link rel=stylesheet href=https://flavono123.github.io/assets/css/post.css>
<script defer src=https://flavono123.github.io/assets/js/lbox.js></script>
<link rel=stylesheet href=https://flavono123.github.io/assets/css/common.css>
</head>
<body>
<main>
<header>
<a class=site-title href=https://flavono123.github.io/>flavono123</a>
</header>
<section class=article>
<div class=article-header>
<h2 class=article-title>컨테이너 런타임 CRI-O 사용 시 오류 해결: ping: permission denied (are you root?)</h2>
<small class=date>Wed Aug 10, 2022</small>
<div class=tags>
<a href=https://flavono123.github.io/tags/kubernetes class=tag>kubernetes</a>
<a href=https://flavono123.github.io/tags/container class=tag>container</a>
</div>
</div>
<div class=content><h2 id=문제>문제</h2>
<p>쿠버네티스 컨테이너 런타임으로 containerd 대신 <a href=https://cri-o.io/>CRI-O</a>를 검토하던 중 ping 테스트에서 다음 오류가 발생했다:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>/ <span style=color:#75715e># ping 172.16.40.67</span>
PING 172.16.40.67 <span style=color:#f92672>(</span>172.16.40.67<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
ping: permission denied <span style=color:#f92672>(</span>are you root?<span style=color:#f92672>)</span>
</code></pre></div><p>CNI는 Calico를 사용했고, <a href=https://projectcalico.docs.tigera.io/getting-started/kubernetes/hardway/test-networking>ping 테스트는 Calico 문서</a> 것 그대로 했다(IP는 다른 워커 노드의 파드의 것이다).</p>
<h2 id=해결>해결</h2>
<p>처음 보는 오류 메시지를 검색하니 CRI-O는 <a href=https://man7.org/linux/man-pages/man7/capabilities.7.html>CAP_NET_RAW</a>라는 ping에 필요한 capability가 기본으로 없다는 것을 알게 됐다:</p>
<h3 id=default_capabilities>default_capabilities</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ crio config | grep default_capabilities -A <span style=color:#ae81ff>10</span>
INFO<span style=color:#f92672>[</span>2022-08-10 06:14:49.820468258Z<span style=color:#f92672>]</span> Starting CRI-O, version: 1.24.2, git: bd548b04f78a30e1e9d7c17162714edd50edd6ca<span style=color:#f92672>(</span>clean<span style=color:#f92672>)</span>
INFO Using default capabilities: CAP_CHOWN, CAP_DAC_OVERRIDE, CAP_FSETID, CAP_FOWNER, CAP_SETGID, CAP_SETUID, CAP_SETPCAP, CAP_NET_BIND_SERVICE, CAP_KILL, CAP_NET_RAW
default_capabilities <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;CHOWN&#34;</span>,
        <span style=color:#e6db74>&#34;DAC_OVERRIDE&#34;</span>,
        <span style=color:#e6db74>&#34;FSETID&#34;</span>,
        <span style=color:#e6db74>&#34;FOWNER&#34;</span>,
        <span style=color:#e6db74>&#34;SETGID&#34;</span>,
        <span style=color:#e6db74>&#34;SETUID&#34;</span>,
        <span style=color:#e6db74>&#34;SETPCAP&#34;</span>,
        <span style=color:#e6db74>&#34;NET_BIND_SERVICE&#34;</span>,
        <span style=color:#e6db74>&#34;KILL&#34;</span>,
<span style=color:#f92672>]</span>
</code></pre></div><p>원랜 CAP_NET_RAW와 CAP_SYS_CHROOT도 default_capabilities에 있었으나 <a href=https://cri-o.github.io/cri-o/v1.18.0.html>1.18에서 보안 강화를 위해 삭제</a>됐다.</p>
<p>따라서 crio config TOML 파일(Ubuntu에선 /etc/crio/crio.conf 또는 /etc/crio/crio.conf.d/ 하위)에 다음을 추가하여 CAP_NET_RAW를 default_capabilities에 추가했다:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>crio.runtime<span style=color:#f92672>]</span>
default_capabilities <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
	<span style=color:#e6db74>&#34;CHOWN&#34;</span>,
	<span style=color:#e6db74>&#34;DAC_OVERRIDE&#34;</span>,
	<span style=color:#e6db74>&#34;FSETID&#34;</span>,
	<span style=color:#e6db74>&#34;FOWNER&#34;</span>,
	<span style=color:#e6db74>&#34;SETGID&#34;</span>,
	<span style=color:#e6db74>&#34;SETUID&#34;</span>,
	<span style=color:#e6db74>&#34;SETPCAP&#34;</span>,
	<span style=color:#e6db74>&#34;NET_BIND_SERVICE&#34;</span>,
	<span style=color:#e6db74>&#34;KILL&#34;</span>,
	<span style=color:#e6db74>&#34;NET_RAW&#34;</span>,
<span style=color:#f92672>]</span>
</code></pre></div><p>그런데 여전히 ping이 되질 않았다. 혹시 바뀐 설정이 적용 안되는걸까하여 <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container>파드 capabilities에 NET_RAW를 추가했더니(<code>.spec.containers[].securityContext.capabilities.add</code>)</a> ping이 되기 시작했다.</p>
<p>CAP_NET_RAW가 없어서 발생하는 문젠 맞는데 CRI-O default_capabilities가 적용되지 않는걸로 보였다.</p>
<h3 id=버그>버그!</h3>
<p>crio 그리고 (default_)capabilities로 계속 검색하다가 현재 최신 버전인 1.24에 관련한 버그가 있단것을 알게 됐다.</p>
<p><a href=https://github.com/cri-o/cri-o/security/advisories/GHSA-4hj2-r2pm-3hc6>https://github.com/cri-o/cri-o/security/advisories/GHSA-4hj2-r2pm-3hc6</a></p>
<blockquote>
<p>A bug was found in CRI-O where containers were incorrectly started with non-empty inheritable Linux process capabilities, creating an atypical Linux environment and enabling programs with inheritable file capabilities to elevate those capabilities to the permitted set during execve(2). Normally, when executable programs have specified permitted file capabilities, otherwise unprivileged users and processes can execute those programs and gain the specified file capabilities up to the bounding set. Due to this bug, containers which included executable programs with inheritable file capabilities allowed otherwise unprivileged users and processes to additionally gain these inheritable file capabilities up to the container&rsquo;s bounding set. Containers which use Linux users and groups to perform privilege separation inside the container are most directly impacted.</p>
</blockquote>
<p>버그 영향 내용을 보면 오히려 의도하지 않은 cap이 컨테이너로 상속되어 확장될 수 있다고 이해했지만, 버전의 문제일 것이라 가정하고 CRI-O 다운그레이드하여 ping 테스트를 해봤다. Ping 테스트에서 사용한 busybox엔 <a href=https://man7.org/linux/man-pages/man1/capsh.1.html>capsh</a>이 없어서 <a href=https://man7.org/linux/man-pages/man1/setpriv.1.html>setpriv</a>로 capabilities를 확인해봤다. 먼저 다운그레이드 이전 버전에서 확인해보고:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># crio 1.24.2</span>
/ <span style=color:#75715e># setpriv -d</span>
uid: <span style=color:#ae81ff>0</span>
euid: <span style=color:#ae81ff>0</span>
gid: <span style=color:#ae81ff>0</span>
egid: <span style=color:#ae81ff>0</span>
Supplementary groups: <span style=color:#ae81ff>10</span>
no_new_privs: <span style=color:#ae81ff>0</span>
Inheritable capabilities: <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>
Ambient capabilities: setpriv: prctl: CAP_AMBIENT_IS_SET: Invalid argument

---
</code></pre></div><p>1.23.3으로 다운그레이드 했다. 이 버전도 default_capabilities는 크게 다르지 않다. setpriv로 확인한 Inheritable capabilities에 net_raw도 확인할 수 있다(none이 아니다). ping도 이제 동작한다:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># crio 1.23.3</span>
/ <span style=color:#75715e># setpriv -d</span>
uid: <span style=color:#ae81ff>0</span>
euid: <span style=color:#ae81ff>0</span>
gid: <span style=color:#ae81ff>0</span>
egid: <span style=color:#ae81ff>0</span>
Supplementary groups: <span style=color:#ae81ff>10</span>
no_new_privs: <span style=color:#ae81ff>0</span>
Inheritable capabilities: chown,dac_override,fowner,fsetid,kill,setgid,setuid,setpc
ap,net_bind_service,net_raw
Ambient capabilities: setpriv: prctl: CAP_AMBIENT_IS_SET: Invalid argument

/ <span style=color:#75715e># ping 172.16.25.199 -c 5</span>
PING 172.16.25.199 <span style=color:#f92672>(</span>172.16.25.199<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
<span style=color:#ae81ff>64</span> bytes from 172.16.25.199: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>62</span> time<span style=color:#f92672>=</span>0.662 ms
<span style=color:#ae81ff>64</span> bytes from 172.16.25.199: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>62</span> time<span style=color:#f92672>=</span>0.690 ms
<span style=color:#ae81ff>64</span> bytes from 172.16.25.199: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>62</span> time<span style=color:#f92672>=</span>0.702 ms
<span style=color:#ae81ff>64</span> bytes from 172.16.25.199: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>62</span> time<span style=color:#f92672>=</span>0.570 ms
<span style=color:#ae81ff>64</span> bytes from 172.16.25.199: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>62</span> time<span style=color:#f92672>=</span>0.712 ms

--- 172.16.25.199 ping statistics ---
<span style=color:#ae81ff>5</span> packets transmitted, <span style=color:#ae81ff>5</span> packets received, 0% packet loss
round-trip min/avg/max <span style=color:#f92672>=</span> 0.570/0.667/0.712 ms
</code></pre></div><p>글쓰는 시점 <a href=https://github.com/cri-o/cri-o/pull/6070>버그는 아직 수정 중인걸로 보인다</a>.</p>
<p>CRI-O가 contaierd에 비해 경량이라는 이유로 PoC를 진행해보고 있었는데, 컨테이너 보안 측면에서도 공격 표면이 더 적다는 것을 체감했다. 또 Linux capabilities도 종류가 너무 많아 어찌 공부할지 감이 안왔는데 NET_RAW 등 몇가지를 알게 됐다.</p>
<h2 id=정리>정리</h2>
<ul>
<li>CRI-O는 containerd에 비해 컨테이너 프로세스에 허용하는 기본 capabilities가 적다.</li>
<li>패킷 소켓을 사용하는 ping 같은 명령엔 CAP_NET_RAW capability가 필요하다.</li>
</ul>
<hr>
<h2 id=참고>참고</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=ZKJ9oFwjosM">https://www.youtube.com/watch?v=ZKJ9oFwjosM</a></li>
<li><a href=https://cri-o.io/>https://cri-o.io/</a></li>
<li><a href=https://github.com/cri-o/cri-o/blob/main/docs/crio.conf.5.md>https://github.com/cri-o/cri-o/blob/main/docs/crio.conf.5.md</a></li>
<li><a href=https://man7.org/linux/man-pages/man7/capabilities.7.html>https://man7.org/linux/man-pages/man7/capabilities.7.html</a></li>
<li><a href=https://busybox.net/>https://busybox.net/</a></li>
</ul>
</div>
</section>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//flavono123.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<footer>
<p>&copy; 2021 - 2022 </p>
</footer>
</main>
</body>
</html>