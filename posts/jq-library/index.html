<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>jq 커스텀 함수 라이브러리화 | flavono123</title>
<link rel=stylesheet href=https://flavono123.github.io/assets/css/post.css>
<script defer src=https://flavono123.github.io/assets/js/lbox.js></script>
<link rel=stylesheet href=https://flavono123.github.io/assets/css/common.css>
</head>
<body>
<main>
<header>
<a class=site-title href=https://flavono123.github.io/>flavono123</a>
</header>
<section class=article>
<div class=article-header>
<h2 class=article-title>jq 커스텀 함수 라이브러리화</h2>
<small class=date>Thu Mar 31, 2022</small>
<div class=tags>
<a href=https://flavono123.github.io/tags/jq class=tag>jq</a>
</div>
</div>
<div class=content><p>이전 글 <a href=/posts/jq-custom-function/>&ldquo;jq 커스텀 함수 사용(Elasticsearch 프로퍼티 매핑 JSON 만들기)"</a>에서 좀 불편한 점이 있다. <code>-f</code> 옵션을 단 하나만 쓰기 때문에 인자인 필터 파일 하나에 아주 작은 수정도 입력해야 한다. 실제로 &ldquo;e&rdquo; 경로를 보기 위해 <code>| .e</code>를 <strong>파일에</strong> 써 주었다. 길고 복잡해진 필터를 파일에 썼지만, 명령줄에서 파이프(합성)하여 쓰는 이점이 사라졌다.</p>
<p>이런 문제점을 해결하기 위해jq는 라이브러리(모듈) 기능을 제공한다.</p>
<p><a href=/posts/jq-sort-json/>&ldquo;jq 필터로 JSON 정렬하기&rdquo;</a>에서 예로 든 JSON 정렬 필터를 예시로 들어 본다. 먼저 작업 디렉토리에 jqlib 라는 디렉토리를 만들고 아래 ./jqlib/script.jq 라는 파일에 함수로 정의했다:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>❯ cat jqlib/script.jq
def jsort:
  walk<span style=color:#f92672>(</span>
    <span style=color:#66d9ef>if</span> type<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;object&#34;</span> <span style=color:#66d9ef>then</span>
      to_entries | sort_by<span style=color:#f92672>(</span>.key<span style=color:#f92672>)</span> | from_entries
    <span style=color:#66d9ef>else</span>
      .
    end
  <span style=color:#f92672>)</span>;

❯ echo <span style=color:#e6db74>&#39;{&#34;b&#34;: {&#34;d&#34;: {&#34;g&#34;: 5, &#34;f&#34;: 4, &#34;e&#34;: 3},&#34;c&#34;: 2},&#34;a&#34;:1}&#39;</span> | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> jq -L jqlib <span style=color:#e6db74>&#39;include &#34;script&#34;; jsort&#39;</span>
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;a&#34;</span>: 1,
  <span style=color:#e6db74>&#34;b&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;c&#34;</span>: 2,
    <span style=color:#e6db74>&#34;d&#34;</span>: <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;e&#34;</span>: 3,
      <span style=color:#e6db74>&#34;f&#34;</span>: 4,
      <span style=color:#e6db74>&#34;g&#34;</span>: <span style=color:#ae81ff>5</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

</code></pre></div><ul>
<li>커스텀 함수를 정의하는 라이브러리 파일은 .jq 확장자로 저장한다.</li>
<li><code>-L</code> 인자는 디렉토리를 주어야 한다. 아래의 .jq 파일을 읽을 수 있다.</li>
<li><code>include "script"</code>: 라이브러리 경로 아래의, 확장자를 제외한 파일명을 주면 정의된 함수를 로드한다.</li>
</ul>
<p><a href=/posts/jq-custom-function/>&ldquo;jq 커스텀 함수 사용(Elasticsearch 프로퍼티 매핑 JSON 만들기)"</a>에서 정의한 함수는 범용적이지 않다. 이를 위해 네임스페이스를 주는 모듈 기능도 제공한다. 이번엔 같은 라이브러리 디렉토리 밑에 es.jq라는 이름의 파일에ES 프로퍼티 매핑 관련 함수를 썼다:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>❯ cat jqlib/es.jq
def floatorinteger:
  <span style=color:#66d9ef>if</span> tostring | test<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\\.&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>then</span>
    <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;float&#34;</span> <span style=color:#f92672>}</span>
  <span style=color:#66d9ef>else</span>
    <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span> <span style=color:#f92672>}</span>
  end;

def dateorstring:
  <span style=color:#66d9ef>if</span> test<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>then</span>
    <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;date&#34;</span> <span style=color:#f92672>}</span>
  <span style=color:#66d9ef>else</span>
    <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
      <span style=color:#e6db74>&#34;fields&#34;</span>: <span style=color:#f92672>{</span>
        <span style=color:#e6db74>&#34;keyword&#34;</span>: <span style=color:#f92672>{</span>
          <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;keyword&#34;</span>,
          <span style=color:#e6db74>&#34;ignore_above&#34;</span>: <span style=color:#ae81ff>256</span>
        <span style=color:#f92672>}</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
  end;

def estype:
  <span style=color:#66d9ef>if</span> type<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;number&#34;</span> <span style=color:#66d9ef>then</span>
    floatorinteger
  <span style=color:#66d9ef>elif</span> type<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;string&#34;</span> <span style=color:#66d9ef>then</span>
    dateorstring
  <span style=color:#66d9ef>else</span>
    <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;type&#34;</span>: type <span style=color:#f92672>}</span>
  end;

def esprop:
  <span style=color:#66d9ef>if</span> type<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;object&#34;</span> <span style=color:#66d9ef>then</span>
    <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;properties&#34;</span>: with_entries<span style=color:#f92672>(</span>.value |<span style=color:#f92672>=</span> estype<span style=color:#f92672>)}</span>
  <span style=color:#66d9ef>else</span>
    estype
  end;

❯ echo <span style=color:#e6db74>&#39;{&#34;a&#34;: 1}&#39;</span> | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> jq -L jqlib <span style=color:#e6db74>&#39;import &#34;es&#34; as es; with_entries(.value |= es::esprop)&#39;</span>
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;a&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul>
<li><code>import "es" as es</code>: 라이브러리 경로 아래의, 확장자를 제외한 파일명을 module 네임스페이스에 정의된 함수를 로드한다.</li>
<li><code>es::esprop</code>: 사용할 땐 <code>&lt;module>::&lt;function></code>으로 호출한다.</li>
</ul>
<p>또 jq는 $HOME/.jq를 기본 라이브러리 경로로 로드한다. 따라서 <a href=https://github.com/flavono123/dotfiles/tree/master/jq/.jq>dotfiles에 자주 사용하는 jq 필터를 만들어 두고</a> 쓰면 된다.</p>
<h2 id=정리>정리</h2>
<ul>
<li>커스텀 함수는 .jq 확장자 파일에 저장하고 jq 실행 시 라이브러리로 불러올 수 있다.</li>
<li><code>-L</code>로 라이브러리 경로를 추가하거나 $HOME/.jq에서 기본으로 불러올 수 있다.</li>
<li><code>include "&lt;file>"</code>은 전역에 함수를 로드한다.</li>
<li><code>import "&lt;file>" as &lt;module></code>로 module 네임스페이스에 함수를 로드한다.</li>
</ul>
<hr>
<h2 id=참고>참고</h2>
<ul>
<li><a href=https://stedolan.github.io/jq/manual/v1.6/#Modules>https://stedolan.github.io/jq/manual/v1.6/#Modules</a></li>
<li><a href=https://github.com/stedolan/jq/issues/461>https://github.com/stedolan/jq/issues/461</a></li>
<li><a href="https://stackoverflow.com/questions/71660127/jq-file-format-as-filter-f-vs-library-l?noredirect=1#comment126649007_71660127">https://stackoverflow.com/questions/71660127/jq-file-format-as-filter-f-vs-library-l?noredirect=1#comment126649007_71660127</a></li>
</ul>
</div>
</section>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//flavono123.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<footer>
<p>&copy; 2021 - 2023 </p>
</footer>
</main>
</body>
</html>